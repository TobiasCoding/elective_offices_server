{% extends "layout.html" %}
{% block content %}
<h2>Processed results</h2>

<table id="results-table">
  <thead>
    <tr>
      <!-- Visible column headers (translated) -->
      <th>Year</th>
      <th>Type</th>
      <th>Category</th>
      <th>Office</th>
      <th>Method</th>
      <th>Last Calc</th>
      <th>Result</th>
      <th class="actions">Actions</th>
    </tr>
    <!-- Filters row: will be populated by JS with available options per column -->
    <tr id="filters-row">
      <!-- Each <th> will receive a <select> built from unique values in that column -->
      <th data-filter-for="Year"></th>
      <th data-filter-for="Type"></th>
      <th data-filter-for="Category"></th>
      <th data-filter-for="Office"></th>
      <th data-filter-for="Method"></th>
      <th data-filter-for="Last Calc"></th>
      <th data-filter-for="Result"></th>
      <th><!-- no filter for Actions --></th>
    </tr>
  </thead>
  <tbody>
    {% for row in rows %}
    <tr data-year="{{ row.year }}" data-type="{{ row.election_type }}" data-category="{{ row.category }}"
      data-office="{{ row.office }}" data-method="{{ row.method }}" data-lastcalc="{{ row.last_calc or '-' }}"
      data-hasresult="{{ 'yes' if row.result else 'no' }}">
      <td>{{ row.year }}</td>
      <td>{{ row.election_type }}</td>
      <td>{{ row.category }}</td>
      <td>{{ row.office }}</td>
      <td>{{ row.method }}</td>
      <td>{{ row.last_calc or '-' }}</td>
      <td>
        {% if row.result %}
        <details>
          <summary class="btn ok">View allocation</summary>
          <pre class="mono">{{ row.result|tojson(indent=2) }}</pre>
        </details>
        {% else %}
        -
        {% endif %}
      </td>
      <td class="right">
        <!-- Single action: Sync & Calc (rightmost). 
             Uses data-* attributes from the row for payload. -->
        <button class="btn primary sync-btn" type="button" data-year="{{ row.year }}"
          data-type="{{ row.election_type }}" data-category="{{ row.category }}" data-office="{{ row.office }}"
          data-method="{{ row.method }}" title="Synchronize sources and calculate results">
          Sync &amp; Calc
        </button>
        <span class="spinner" aria-hidden="true" title="Processing"></span>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Minimal styles; rely on existing .btn/.ok/.mono if defined in layout.css -->
<style>
    .spinner {
    display: none;            /* visible solo mientras se envía */
    width: 14px; height: 14px;
    margin-left: 8px; vertical-align: middle;
    border: 2px solid #bbb;   /* borde gris */
    border-top-color: #fff;   /* “sector” blanco */
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .btn.is-loading { opacity: .7; pointer-events: none; }
  #results-table {
    width: 100%;
    border-collapse: collapse;
  }

  #results-table th,
  #results-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #ddd;
    vertical-align: top;
  }

  #results-table thead th {
    text-align: left;
  }

  #results-table thead tr#filters-row th {
    padding: 6px 10px;
  }

  #results-table select {
    width: 100%;
    max-width: 220px;
  }

  td.right,
  th.actions {
    text-align: right;
    white-space: nowrap;
  }

  .btn {
    cursor: pointer;
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #3b3b3b;
  }

  .btn.primary {
    background: rgb(78, 78, 78);
    border-color: #aac;
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
</style>

<script>
  // --- Helper: extract a normalized display value for a cell (used in filtering) ---
  function cellDisplayValue(td, colName) {
    // For "Result" we consider "With result" vs "-"
    if (colName === "Result") {
      const hasDetails = td.querySelector("details") !== null;
      return hasDetails ? "With result" : "-";
    }
    const text = (td.textContent || "").trim();
    return text === "" ? "-" : text;
  }

  // --- Build filter selects using unique values found in each column ---
    document.addEventListener("DOMContentLoaded", () => {
      const table = document.getElementById("results-table");
      const tbody = table.querySelector("tbody");

      // --- Sync & Calc action handler (FIX: URL y finally) ---
      tbody.addEventListener("click", async (ev) => {
        const btn = ev.target.closest(".sync-btn");
        if (!btn) return;
        const tr = btn.closest("tr");
        const spin = tr.querySelector(".spinner");

        // UI: loading on
        btn.classList.add("is-loading");
        btn.disabled = true;
        if (spin) spin.style.display = "inline-block";

        // payload desde atributos data-*
        const payload = {
          year: tr.getAttribute("data-year"),
          election_type: tr.getAttribute("data-type"),
          category: tr.getAttribute("data-category"),
          office: tr.getAttribute("data-office"),
          method: tr.getAttribute("data-method")
        };

        try {
          // FIX: URL correcta (sin /config)
          const res = await fetch("/elective_office/config/preprocess_and_calc", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("Request failed: " + res.status);

          btn.textContent = "Queued ✓";
        } catch (e) {
          console.error(e);
          alert("Sync & Calc failed. Check logs.");
        } finally {
          // UI: loading off (siempre)
          if (spin) spin.style.display = "none";
          btn.classList.remove("is-loading");
          btn.disabled = false; // si preferís dejarlo deshabilitado, quitá esta línea
        }
      });
    });

  // Activa spinner en forms de preprocess/calc mientras se navega
  (function () {
    function armSpinnerHandlers(selector) {
      document.querySelectorAll(selector).forEach(form => {
        form.addEventListener('submit', (ev) => {
          // botón que disparó el submit (si existe)
          const btn = ev.submitter || form.querySelector('button[type="submit"]');
          const spin = form.querySelector('.spinner');
          if (btn) btn.classList.add('is-loading');
          if (btn) btn.disabled = true;
          if (spin) spin.style.display = 'inline-block';
          // no prevenimos el submit: dejamos que navegue
        });
      });
    }
  })();

</script>
{% endblock %}